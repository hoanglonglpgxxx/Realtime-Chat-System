name: Deploy Chat System

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./apps/backend
          file: ./apps/backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/chat-backend:latest

      - name: Build and Push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./apps/frontend
          file: ./apps/frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/chat-frontend:latest

      # Buoc 3: Day file .env ngang cap co san tu Repo
      - name: Copy Config files to VM 1
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.VM1_PUBLIC_IP }}
          username: mitsne
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "apps/docker-compose.yml"
          target: "/home/mitsne/realtime-chat/"

      # Buoc 4: Deploy VM 1 - Khong dung echo
      - name: Deploy to VM 1
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM1_PUBLIC_IP }}
          username: mitsne
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/mitsne/realtime-chat/apps

            echo "BE_PORT=${{ secrets.BE_PORT }}" > .env
            echo "FE_PORT=${{ secrets.FE_PORT }}" >> .env
            echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> .env
            echo "VM2_INTERNAL_IP=${{ secrets.VM2_INTERNAL_IP }}" >> .env
            echo "MONGO_USER=${{ secrets.MONGO_USER }}" >> .env
            echo "MONGO_PASS=${{ secrets.MONGO_PASS }}" >> .env
            echo "REDIS_PASS=${{ secrets.REDIS_PASS }}" >> .env
            echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> .env

            docker compose pull
            docker compose up -d --no-build

      # Buoc 5: Sync Infra sang VM 2 (Lay luon .env co san trong folder)
      - name: Sync Infrastructure to VM 2
        run: |
          eval $(ssh-agent -s)
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' | ssh-add -
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VM1_PUBLIC_IP }} >> ~/.ssh/known_hosts
          scp -o "ProxyJump mitsne@${{ secrets.VM1_PUBLIC_IP }}" -o ForwardAgent=yes -o "StrictHostKeyChecking=no" \
              -r ./infrastructure/* mitsne@${{ secrets.VM2_INTERNAL_IP }}:/home/mitsne/realtime-chat/infrastructure/

      # Buoc 6: Restart VM 2 - Khong dung echo
      - name: Restart DBs on VM 2
        run: |
          eval $(ssh-agent -s)
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' | ssh-add -
          ssh -o "ProxyJump mitsne@${{ secrets.VM1_PUBLIC_IP }}" -o ForwardAgent=yes -o "StrictHostKeyChecking=no" \
              mitsne@${{ secrets.VM2_INTERNAL_IP }} "
                cd /home/mitsne/realtime-chat/infrastructure && \
                
                # Nạp đúng biến khởi tạo DB cho Infra
                echo 'MONGO_USER=${{ secrets.MONGO_USER }}' > .env && \
                echo 'MONGO_PASS=${{ secrets.MONGO_PASS }}' >> .env && \
                echo 'REDIS_PASS=${{ secrets.REDIS_PASS }}' >> .env && \
                
                docker compose pull && \
                docker compose up -d
              "
