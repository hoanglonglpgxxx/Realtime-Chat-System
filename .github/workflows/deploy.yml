name: Deploy Chat System

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and Push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./apps/backend
          file: ./apps/backend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/chat-backend:latest

      - name: Build and Push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./apps/frontend
          file: ./apps/frontend/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/chat-frontend:latest

      # Buoc 3: Day file docker-compose sang VM 1
      - name: Copy Config files to VM 1
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.VM1_PUBLIC_IP }}
          username: mitsne
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "apps/docker-compose.yml"
          target: "/home/mitsne/realtime-chat/"

      # Buoc 4: Deploy VM 1 (Backend & Frontend)
      - name: Deploy to VM 1
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM1_PUBLIC_IP }}
          username: mitsne
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/mitsne/realtime-chat/apps

            # Tao .env cho App (VM 1 co mang nen ke no)
            echo "BE_PORT=${{ secrets.BE_PORT }}" > .env
            echo "FE_PORT=${{ secrets.FE_PORT }}" >> .env
            echo "REDIS_PORT=${{ secrets.REDIS_PORT }}" >> .env
            echo "VM2_INTERNAL_IP=${{ secrets.VM2_INTERNAL_IP }}" >> .env
            echo "MONGO_USER=${{ secrets.MONGO_USER }}" >> .env
            echo "MONGO_PASS=${{ secrets.MONGO_PASS }}" >> .env
            echo "REDIS_PASS=${{ secrets.REDIS_PASS }}" >> .env
            echo "DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}" >> .env

            docker compose pull
            docker compose up -d --no-build

      # Buoc 5: Sync file cau hinh Infra sang VM 2
      - name: Sync Infrastructure to VM 2
        run: |
          eval $(ssh-agent -s)
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' | ssh-add -
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VM1_PUBLIC_IP }} >> ~/.ssh/known_hosts

          # Day file config sang VM 2 (redis.conf, users.acl...)
          scp -o "ProxyJump mitsne@${{ secrets.VM1_PUBLIC_IP }}" -o ForwardAgent=yes -o "StrictHostKeyChecking=no" \
              -r ./infrastructure/* mitsne@${{ secrets.VM2_INTERNAL_IP }}:/home/mitsne/realtime-chat/infrastructure/

      # [MOI] Buoc 5.5: Dung VM 1 lam "nguoi van chuyen" Image sang VM 2
      - name: Bridge Images from VM 1 to VM 2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM1_PUBLIC_IP }}
          username: mitsne
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Dừng ngay nếu có lỗi
            set -e

            echo ">>> 1. Pulling Images on VM 1..."
            docker pull mongo:latest
            docker pull redis:alpine
            docker pull nginx:alpine

            echo ">>> 2. Saving Images to TAR..."
            docker save -o infra_images.tar mongo:latest redis:alpine nginx:alpine

            echo ">>> 3. Preparing Key for Transfer..."
            # [QUAN TRỌNG] Tạo file key tạm trên VM 1 để nó có quyền vào VM 2
            echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_rsa_temp
            chmod 600 id_rsa_temp

            echo ">>> 4. Sending TAR to VM 2..."
            # Dùng key tạm (-i) để SCP sang VM 2
            scp -i id_rsa_temp -o "StrictHostKeyChecking=no" infra_images.tar mitsne@${{ secrets.VM2_INTERNAL_IP }}:/home/mitsne/realtime-chat/infrastructure/

            echo ">>> 5. Cleaning up..."
            # Xóa sạch dấu vết
            rm id_rsa_temp
            rm infra_images.tar

      # Buoc 6: Giai nen va Chay tren VM 2 (Khong can internet)
      - name: Restart DBs on VM 2
        run: |
          eval $(ssh-agent -s)
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' | ssh-add -
          ssh -o "ProxyJump mitsne@${{ secrets.VM1_PUBLIC_IP }}" -o ForwardAgent=yes -o "StrictHostKeyChecking=no" \
              mitsne@${{ secrets.VM2_INTERNAL_IP }} "
                cd /home/mitsne/realtime-chat/infrastructure && \
                
                # Giai nen Image
                echo '>>> 4. Loading Images...' && \
                docker load -i infra_images.tar && \
                rm infra_images.tar && \
                
                # Tao .env
                echo 'MONGO_USER=${{ secrets.MONGO_USER }}' > .env && \
                echo 'MONGO_PASS=${{ secrets.MONGO_PASS }}' >> .env && \
                echo 'REDIS_PASS=${{ secrets.REDIS_PASS }}' >> .env && \
                
                # Chi Up, khong Pull
                echo '>>> 5. Starting Services...' && \
                docker compose up -d
              "
